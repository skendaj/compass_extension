# Teams Pre-filled Message Fix

## Problem Identified

When users clicked "Teams Chat" from an expert card in Navify, Teams was auto-generating a greeting message like "Hi Andrea Vitali," instead of using the actual search question.

### Root Cause

The Teams deep link URL was missing the `message` parameter:

```typescript
// BEFORE (in ResultsView.tsx)
window.open(
  `https://teams.microsoft.com/l/chat/0/0?users=${user.email}`,
  "_blank"
);
```

When the `message` parameter is missing, Teams **automatically generates** a greeting based on the recipient's name:
- URL: `...?users=a.vitali01@teamsystem.com`
- Teams generates: `message=Hi%20Andrea%20Vitali%2C`

This resulted in the chat always starting with "Hi [Name]," instead of the actual question.

## Solution

Pass the actual search query as the `message` parameter in the Teams URL:

```typescript
// AFTER (in ResultsView.tsx)
const message = encodeURIComponent(query);
window.open(
  `https://teams.microsoft.com/l/chat/0/0?users=${encodeURIComponent(user.email)}&message=${message}`,
  "_blank"
);
```

## How It Works Now

### User Flow

1. **User searches:** "How to deploy to production?"
2. **User clicks:** "Teams Chat" on expert card
3. **Storage saved:** `currentSearchQuery = "How to deploy to production?"`
4. **Teams opens with:** Pre-filled message = "How to deploy to production?"
5. **User can:** Send as-is or modify before sending
6. **Capture shows:** "How to deploy to production?" (from storage)

### URL Comparison

**Before:**
```
https://teams.microsoft.com/dl/launcher/launcher.html?
  url=%2F_%23%2Fl%2Fchat%2F0%2F0%3F
  users%3Da.vitali01%2540teamsystem.com%26
  message%3DHi%2520Andrea%2520Vitali%252C  ← Auto-generated by Teams
```

**After:**
```
https://teams.microsoft.com/dl/launcher/launcher.html?
  url=%2F_%23%2Fl%2Fchat%2F0%2F0%3F
  users%3Da.vitali01%2540teamsystem.com%26
  message%3DHow%2520to%2520deploy%2520to%2520production%253F  ← From query
```

## Benefits

### ✅ Immediate Benefits

1. **No More Greetings**
   - Chat starts with the actual question
   - No need to remove "Hi Name," prefix

2. **Consistent Question**
   - Stored query matches pre-filled message
   - User sees exactly what they searched for

3. **Faster Workflow**
   - User can hit Enter immediately
   - No need to type or modify the question

4. **Better Context**
   - Expert sees the question right away
   - Clearer conversation from the start

### ✅ Capture Benefits

When capturing the chat:

**Before Fix:**
```
QUESTION: Hi Andrea Vitali,
(Wrong - just the greeting)
```

**After Fix:**
```
QUESTION: How to deploy to production?
(Correct - the actual question)
```

## Code Changes

### File: `src/components/ResultsView.tsx`

**Lines Changed:** ~42-44

```diff
  const openTeamsChat = async (user: UserType) => {
    if (user.contactMethods.teams) {
      await chrome.storage.local.set({ currentSearchQuery: query });
      console.log("[ResultsView] Stored search query for Teams chat:", query);

+     // Use the actual question as the message instead of letting Teams auto-generate "Hi Name,"
+     const message = encodeURIComponent(query);
      window.open(
-       `https://teams.microsoft.com/l/chat/0/0?users=${user.email}`,
+       `https://teams.microsoft.com/l/chat/0/0?users=${encodeURIComponent(user.email)}&message=${message}`,
        "_blank",
      );
    }
  };
```

## Testing

### Test Case 1: Basic Question

1. Search: "How to reset password?"
2. Click "Teams Chat"
3. **Expected:** Teams opens with "How to reset password?" pre-filled
4. Send message
5. Capture chat
6. **Expected:** Question shows "How to reset password?"

### Test Case 2: Question with Special Characters

1. Search: "API error: 500 & timeout?"
2. Click "Teams Chat"
3. **Expected:** Teams shows "API error: 500 & timeout?" (properly encoded)
4. Send and capture
5. **Expected:** Question preserved correctly

### Test Case 3: Long Question

1. Search: "How to configure SSL certificates for production deployment with Azure Key Vault?"
2. Click "Teams Chat"
3. **Expected:** Full question pre-filled (Teams may truncate in UI but full text is there)
4. Capture works correctly

## URL Encoding

The `encodeURIComponent()` function handles:

| Character | Original | Encoded |
|-----------|----------|---------|
| Space | ` ` | `%20` |
| Question mark | `?` | `%3F` |
| Ampersand | `&` | `%26` |
| Comma | `,` | `%2C` |
| Colon | `:` | `%3A` |

Example:
```typescript
query = "How to fix: API error?"
encodeURIComponent(query) = "How%20to%20fix%3A%20API%20error%3F"
```

## Edge Cases Handled

### Empty Query
```typescript
query = ""
message = ""
// Teams opens with empty message box (user must type)
```

### Very Long Query
```typescript
query = "A very long question that exceeds..." // 500+ chars
message = encodeURIComponent(query)
// Teams accepts it, may show truncated in UI but full text is there
```

### Special Characters
```typescript
query = "Error: 'Cannot connect' & timeout?"
message = "Error%3A%20'Cannot%20connect'%20%26%20timeout%3F"
// All special characters properly encoded
```

## Additional Notes

### Why Not Remove Extraction Logic?

We kept the `extractQuestionFromFirstMessage()` function because:

1. **Fallback:** If storage fails or is cleared
2. **Direct Teams:** User opens Teams directly (not from Navify)
3. **User Modification:** User might edit the pre-filled message before sending

The priority remains:
1. **Stored query** (from search) ✅
2. Extracted question (from first message)
3. "No question recorded"

### KnowledgeDetailView

The `KnowledgeDetailView.tsx` still uses "Hi Name," because:
- It's for viewing existing knowledge entries
- No search query context exists
- User is initiating a new conversation about that entry
- A greeting is appropriate in that context

## Verification Steps

After loading the extension:

1. Open browser console
2. Search in Navify
3. Click "Teams Chat"
4. Check console logs:
   ```
   [ResultsView] Stored search query for Teams chat: How to deploy?
   ```
5. Check Teams URL in address bar:
   ```
   ...&message=How%20to%20deploy%3F
   ```
6. Check message box shows your question (not "Hi Name,")
7. Send, capture, and verify alert shows correct question

## Status

✅ **Fixed and Tested**
- Teams URL now includes `message` parameter
- Pre-filled message is the actual search query
- No more auto-generated greetings
- Captured question is correct

---

**Last Updated:** 2024-01-19  
**Issue:** Teams auto-generating "Hi Name," instead of using search query  
**Fix:** Added `message` parameter to Teams deep link URL  
**Files Modified:** `src/components/ResultsView.tsx`  
**Build Status:** ✅ Passing
