# Teams Integration Improvements

## Overview

This document describes the improvements made to the Teams chat capture and integration features in the Compass extension.

## Changes Made

### 1. Question Mark Addition in Teams Messages

**File:** `compass_extension/src/components/KnowledgeDetailView.tsx`

**Change:** When clicking the Teams button to message an expert, the question now automatically adds a question mark at the end if it's not already there.

```typescript
const getTeamsUrl = (email: string, name: string) => {
  const question = entry.problem.trim().endsWith("?")
    ? entry.problem
    : `${entry.problem}?`;
  const message = encodeURIComponent(`Hi ${name}, ${question}`);
  return `https://teams.microsoft.com/l/chat/0/0?users=${encodeURIComponent(email)}&message=${message}`;
};
```

**Result:** Messages now appear as "Hi Andrea Vitali, How to migrate a project to Vapor 3?" instead of "Hi Andrea Vitali, How to migrate a project to Vapor 3"

---

### 2. Smart Message Filtering in Teams Chat Capture

**File:** `compass_extension/src/services/teamsDOMScraper.ts`

**Problem:** When capturing Teams chats, the system was including ALL messages, including the auto-generated question that was sent when clicking the Teams button.

**Solution:** The system now:

1. Detects auto-generated messages that match the pattern "Hi [Name], [Question]?"
2. Extracts the question from that message
3. Filters to only capture messages AFTER the auto-generated question
4. Uses the extracted question as the primary question for the knowledge entry

**Key Functions Updated:**

- `generateKeySummary()` - Now accepts an optional `autoGeneratedQuestion` parameter
- `extractTeamsChat()` - Returns filtered messages and extracted question

**Example:**
Before:

```
Messages:
1. Unknown: Hi Andrea Vitali, How to migrate a project to Vapor 3?
2. Andrea: Hello you should install the new package from vapor3 now
3. User: Thanks!
```

After:

```
Question: "How to migrate a project to Vapor 3?"
Relevant Messages:
1. Andrea: Hello you should install the new package from vapor3 now
2. User: Thanks!
```

---

### 3. Improved Modal Display

**File:** `compass_extension/src/content.ts`

**Changes:**

- Added a dedicated "Question" section at the top of the captured chat modal
- Shows the extracted question prominently
- Renamed "Questions" section to "Additional Questions" to distinguish from the main question
- Uses the extracted question as the title when saving to Navify
- Passes the question parameter to the new entry form

**Modal Structure:**

```
ðŸ“¥ Captured Teams Chat
â”œâ”€â”€ Chat Name
â”œâ”€â”€ Participants
â”œâ”€â”€ Messages (count of relevant messages only)
â”œâ”€â”€ Date Range
â”œâ”€â”€ â“ Question (NEW - extracted question)
â”œâ”€â”€ ðŸ“ Overview
â”œâ”€â”€ ðŸ”‘ Key Points
â”œâ”€â”€ âœ… Action Items
â””â”€â”€ â“ Additional Questions
```

**Save Flow:**

1. User clicks "Save to Navify" button
2. Opens NewEntryView with pre-populated data
3. After saving, immediately displays the entry in detail view
4. Entry is now searchable and appears in all search results

---

### 4. Frontend Display Integration

**File:** `compass_extension/src/App.tsx`

**Changes:**

- Added `new-entry` view state to show NewEntryView component
- Added `newEntryInitialData` state to pass Teams chat data to the form
- When "Save to Navify" is clicked from Teams modal:
  1. Parses URL parameters (action, title, content, question)
  2. Opens NewEntryView with pre-populated fields
  3. After saving, navigates to detail view to show the saved entry
  4. Entry is immediately available in local storage
  5. Entry appears in future search results

**Key Functions Added:**

- `handleSaveNewEntry()` - Saves entry and navigates to detail view
- `handleCancelNewEntry()` - Cancels creation and returns to search

**Complete Flow:**

```
Teams Chat Capture
       â†“
Extract Question & Filter Messages
       â†“
Show Modal with Summary
       â†“
Click "Save to Navify"
       â†“
Open NewEntryView (pre-populated)
       â†“
User Reviews/Edits & Saves
       â†“
Save to Local Storage
       â†“
Also Save to Backend (if available)
       â†“
Display in Detail View
       â†“
Entry Now Searchable
```

---

### 5. Backend API Integration

**File:** `compass_extension/src/components/NewEntryView.tsx`

**Change:** When saving a knowledge entry from Teams chat, the system now:

1. Saves to local storage (guaranteed to work)
2. Also sends the entry to the backend API at `http://localhost:5000/api/knowledge`
3. Gracefully handles backend being offline without failing the save
4. Entry is immediately visible in the frontend regardless of backend status

**API Call:**

```typescript
const backendUrl = "http://localhost:5000/api/knowledge";
const response = await fetch(backendUrl, {
  method: "POST",
  headers: {
    "Content-Type": "application/json",
  },
  body: JSON.stringify({
    content: JSON.stringify(newEntry),
  }),
});
```

**Important:**

- The frontend display works independently of the backend
- Users can capture and save Teams chats even if backend is offline
- All saved entries are stored in local storage and immediately searchable
- Backend integration is supplementary for data persistence across devices

**Note:** The backend integration is currently set to `http://localhost:5000`. To deploy to production:

1. Update the `backendUrl` constant
2. Consider adding backend URL to settings
3. Add authentication headers if required

---

### 6. Question Parameter Handling

**File:** `compass_extension/src/components/NewEntryView.tsx`

**Change:** The NewEntryView now properly accepts and uses a `question` parameter from the initialData prop:

```typescript
interface NewEntryViewProps {
  onSave: (entry: KnowledgeEntry) => void;
  onCancel: () => void;
  initialData?: {
    title: string;
    content: string;
    question?: string; // NEW
  };
}
```

When Teams chat data is imported, if a question is provided, it's automatically populated in the "Problem/Question" field.

---

### 7. URL Parameter Handling & View Management

**File:** `compass_extension/src/App.tsx`

**Changes:**

1. Added handling for the `action=new-from-teams` URL parameter
2. Opens NewEntryView component with pre-populated Teams data
3. After saving, displays entry in detail view
4. Ensures saved entries are immediately searchable

```typescript
if (action === "new-from-teams") {
  const title = urlParams.get("title");
  const content = urlParams.get("content");
  const question = urlParams.get("question");

  setNewEntryInitialData({
    title,
    content,
    question: question || undefined,
  });
  setCurrentView("new-entry");
}
```

---

## Testing

### Test Scenario 1: Question Mark Addition

1. Open a knowledge entry detail view
2. Click the "Teams" button
3. Verify the message includes a question mark

### Test Scenario 2: Chat Capture with Auto-Question

1. Click Teams button from a knowledge entry (sends "Hi [Name], [Question]?")
2. Have a conversation in Teams
3. Click the "Capture Chat" button on the Teams page
4. Verify:
   - The extracted question appears in the "Question" section
   - Only messages AFTER the auto-generated question are shown
   - Message count reflects only relevant messages

### Test Scenario 3: Complete Save and Display Flow

1. Capture a Teams chat (following Scenario 2)
2. Click "Save to Navify" in the modal
3. Verify:
   - NewEntryView opens with pre-populated data
   - Question field contains the extracted question
   - Solution/Content field contains the filtered messages
4. Click "Save"
5. Verify:
   - Detail view opens showing the saved entry
   - All fields are correctly displayed
6. Go to Search view
7. Search for keywords from your saved entry
8. Verify:
   - Your entry appears in search results
   - Entry is clickable and opens correctly

### Test Scenario 4: Backend Integration

1. Ensure compass-hackathon backend is running on `http://localhost:5000`
2. Capture a Teams chat and save it (complete flow)
3. Check browser console logs for backend save confirmation
4. Verify entry was saved to the database
5. Entry should be visible in frontend immediately

### Test Scenario 5: Offline Graceful Handling

1. Stop the compass-hackathon backend
2. Capture and save a Teams chat
3. Verify:
   - Save completes successfully (local storage)
   - Entry appears in detail view
   - Entry is searchable
   - Console shows warning about backend being offline
   - No error messages shown to user

---

## Backend Setup

To enable the backend integration:

1. Navigate to the compass-hackathon directory:

   ```bash
   cd compass_hackathon
   ```

2. Install dependencies:

   ```bash
   pnpm install
   ```

3. Start the database:

   ```bash
   docker-compose up -d
   ```

4. Run migrations:

   ```bash
   pnpm migration:run
   ```

5. Start the development server:
   ```bash
   pnpm run dev
   ```

The backend will be available at `http://localhost:5000`.

---

## Future Improvements

### 1. Backend URL Configuration

- Add backend URL to Settings page
- Allow users to configure custom backend endpoints
- Support multiple environments (dev, staging, production)

### 2. Advanced Message Filtering

- Support multiple question patterns
- Handle threaded conversations
- Filter out system messages and reactions

### 3. Enhanced Question Extraction

- Use AI/NLP to better identify questions
- Support multi-part questions
- Extract context around questions

### 4. Authentication

- Add JWT or OAuth tokens to backend API calls
- Sync user identity between extension and backend
- Implement permission checks

### 5. Conflict Resolution

- Handle cases where local and backend data differ
- Implement sync strategies
- Add offline queue for failed backend saves

### 6. Analytics

- Track question-to-answer time
- Monitor backend save success rates
- Collect usage metrics

---

## API Documentation

### POST /api/knowledge

Creates a new knowledge entry.

**Request:**

```json
{
  "content": "stringified JSON of KnowledgeEntry object"
}
```

**Response:**

```json
{
  "id": "generated-id",
  "content": "stringified JSON of saved entry",
  "createdAt": "2025-01-19T10:30:00Z"
}
```

**Status Codes:**

- 201: Created successfully
- 400: Invalid request body
- 500: Server error

---

## Troubleshooting

### Issue: Question not extracted correctly

**Solution:** Check that the auto-generated message follows the pattern "Hi [Name], [Question]?"

### Issue: Backend save fails

**Possible causes:**

1. Backend is not running
2. CORS issues (add extension origin to backend CORS config)
3. Invalid data format

**Debug steps:**

1. Check browser console for error messages
2. Verify backend is accessible at `http://localhost:5000`
3. Check backend logs for errors
4. Verify the request payload format

### Issue: All messages captured instead of filtered ones

**Solution:** Ensure the Teams chat includes the auto-generated message. The filtering only works when it can detect the question pattern.

---

## Complete User Flow

### From Teams Chat to Searchable Entry:

1. **Initiate Contact**
   - User finds a knowledge entry
   - Clicks "Teams" button to message expert
   - Message includes question with "?" at end

2. **Conversation in Teams**
   - Expert responds with solution
   - Conversation happens naturally
   - Auto-generated question is in chat history

3. **Capture Chat**
   - User clicks "Capture Chat" button on Teams page
   - System extracts question and filters messages
   - Modal shows summary with extracted question

4. **Review and Save**
   - User clicks "Save to Navify"
   - NewEntryView opens with pre-populated data:
     - Title: Extracted question
     - Problem: Extracted question
     - Solution: Filtered conversation messages
   - User can edit before saving

5. **Saved and Displayed**
   - Entry saves to local storage
   - Entry also saves to backend (if available)
   - Detail view opens showing the new entry
   - Entry is immediately searchable

6. **Find Later**
   - User can search for the entry anytime
   - Entry appears in search results
   - All details preserved and accessible

---

## Notes

- **Works offline**: System is designed to work even if the backend is offline
- **Local-first**: Local storage always takes precedence for reading data
- **Backend sync**: Backend integration is additive - it doesn't replace local storage
- **Immediate availability**: Saved entries are instantly searchable without page refresh
- **Pattern matching**: Question extraction uses pattern matching and may need refinement for edge cases
- **No data loss**: Even if backend fails, entry is saved locally and displayed
